# Week 3 ‚Äî IAM & KMS (Quick Revision Notes)

## 1. IAM Fundamentals
- **User**: human identity
- **Role**: service / temporary identity (Glue, Lambda, EC2)
- **Policy**: permissions (WHAT actions are allowed)

### Policy types
- **Trust policy** ‚Üí who can assume a role
- **Permission policy** ‚Üí what actions the role/user can perform

### STS AssumeRolea# Week 3 ‚Äî IAM & KMS (Quick Revision Notes)

## 1. IAM Fundamentals
- **User**: human identity
- **Role**: service / temporary identity (Glue, Lambda, EC2)
- **Policy**: permissions (WHAT actions are allowed)

### Policy types
- **Trust policy** ‚Üí who can assume a role
- **Permission policy** ‚Üí what actions the role/user can perform

### STS AssumeRole
- Used to temporarily become a role
- Returns temporary credentials
- AWS services (Glue, Lambda) already run as roles (no runtime assume-role)

---

## 2. KMS Core Concepts

### Master Key (CMK)
- Long-term key stored in AWS KMS
- Never leaves KMS
- Encrypts and decrypts **data keys**
- Controlled by **KMS key policy**

### Data Key
- Short-lived symmetric key
- Generated by KMS
- Encrypts **actual data**
- Discarded after use

### Envelope Encryption

- Used to temporarily become a role
- Returns temporary credentials
- AWS services (Glue, Lambda) already run as roles (no runtime assume-role)

---

## 2. KMS Core Concepts

### Master Key (CMK)
- Long-term key stored in AWS KMS
- Never leaves KMS
- Encrypts and decrypts **data keys**
- Controlled by **KMS key policy**

### Data Key
- Short-lived symmetric key
- Generated by KMS
- Encrypts **actual data**
- Discarded after use

### Envelope Encryption

Master Key (CMK)
‚Üì encrypts
Data Key
‚Üì encrypts
Your Data

---

## 3. KMS Authorization Model (EXAM GOLD)

To call any KMS API (`GenerateDataKey`, `Decrypt`, etc.):

‚úî IAM policy must allow the action  
AND  
‚úî KMS key policy must trust the principal  

‚ùå Either missing ‚Üí AccessDenied  
(KMS uses AND logic)

---

## 4. S3 + SSE-KMS Flow

### Upload (PutObject)
1. S3 calls `kms:GenerateDataKey`
2. Data key encrypts object
3. Encrypted object + encrypted data key stored
4. Plain data key discarded

### Download (GetObject)
1. S3 sends encrypted data key to KMS
2. KMS decrypts data key
3. S3 decrypts object in memory
4. Plaintext returned

üìå Encryption/decryption is automatic with SSE-KMS

---

## 5. Required Permissions for SSE-KMS

### IAM Role / User
s3:GetObject
s3:PutObject
s3:ListBucket
kms:GenerateDataKey
kms:Decrypt


‚ùå `kms:Encrypt` is NOT required for S3 SSE-KMS (exam trap)

### KMS Key Policy
- Must trust the IAM role or user

---

## 6. Glue + KMS Mental Model

- Glue runs as an IAM role
- Glue never decrypts data
- S3 decrypts data using Glue role permissions

Glue Role
‚Üì
S3 (GetObject)
‚Üì
KMS (Decrypt data key)
‚Üì
S3 decrypts data
‚Üì
Glue receives plaintext


---

## 7. Common Failure Scenarios

| Issue | Likely Cause |
|-----|-------------|
Glue fails reading data | Missing `kms:Decrypt` |
Upload to SSE-KMS fails | Missing `kms:GenerateDataKey` |
IAM ok, still denied | KMS key policy missing role |
403 error | Permission issue |
404 error | Wrong S3 key |

---

## 8. KMS Grants
- Temporary permissions on a KMS key
- Used heavily by AWS services (S3, Glue, RDS)
- Avoid constant key policy changes
- Usually managed automatically by AWS

üìå Exam answer: **Use KMS grants for temporary access**

---

## 9. Key Rotation
- Adds a new backing key
- Old backing keys retained
- Old data remains decryptable
- Alias and ARN never change
- No re-encryption of existing data

üìå Rotation does NOT break existing data

---

## One-Line Exam Sentences (Memorize)
- KMS master keys encrypt data keys; data keys encrypt data
- KMS requires both IAM policy and key policy
- S3 uses caller permissions to call KMS in SSE-KMS
- Key rotation adds backing keys without deleting old ones

---

## Week 3 Status
‚úî IAM & STS  
‚úî KMS CMK vs Data Keys  
‚úî Envelope Encryption  
‚úî S3 SSE-KMS  
‚úî Glue + KMS  
‚úî Grants & Rotation  

**Week 3 COMPLETE**


